<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>NL_Framework</title>
		<link rel="stylesheet" type="text/css" href="css/normalize.css"/>
		<link rel="stylesheet" type="text/css" href="css/demo.css"/>

		<!--必要样式-->
		<link rel="stylesheet" type="text/css" href="css/component.css"/>
		<link rel="stylesheet" type="text/css" href="css/style.css"/>

    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <py-config>
       packages =["./static/littleutils-0.2.2-py3-none-any.whl", "pandas"]
       [[fetch]]
       files=["./pycode/AggregateVerbalizer.py",
	   		"./pycode/TemplatesGenerator.py",
			"./pycode/ProgramVerbalizer.py",
			"./pycode/utils.py",
	   		"./data/conflicts/chase.json",
			"./data/conflicts/deterministic_verbalization.json",
			"./data/conflicts/templates.json",
			"./data/trading/chase.json",
			"./data/trading/deterministic_verbalization.json",
			"./data/trading/templates.json",
			"./data/ownership/chase.json",
			"./data/ownership/deterministic_verbalization.json",
			"./data/ownership/templates.json",
			"./data/closeLink/chase.json",
			"./data/closeLink/deterministic_verbalization.json",
			"./data/closeLink/templates.json",
			"./data/shock/chase.json",
			"./data/shock/deterministic_verbalization.json",
			"./data/shock/templates.json",]
    </py-config>
	</head>
	<body>
		<div class="container">
			<header class="codrops-header">
				<h2>Logic to NL Explanation Framework</h2>
			</header>

				<section class="content">
				<label for="cars"><b>Choose program:</b></label>

				<select name="examples" id="examples" py-click="get_data()">
					<option value ="NA"></option>
				  	<option value= "PR">Peer Reviews Conflict of Interest</option>
					<option value= "TR">Trading via Smart Contract</option>
					<option value= "OW">Ownership</option>
					<option value= "CL">Close Link</option>
					<option value= "SP">Shock Propagation</option>
			   </select>
			<br/><br/>
			   <div id="logicProgram" style="font-size: 70%"></div>
			<br/><br/>
				 <div id="desc" align="left"></div>
			<br/><br/>
				<div id="query" style="font-size: 80%"></div>
			


      </section>

			<section class="content">
				<div class="divcontainer">
						<div class="dataset">
								<h3>EDB Knowledge:</h3>
									<div id="edb_facts" style="overflow-y: scroll; height:150px;width:300px;">
								</div>
						</div>

						<div class="fact" >
								 <h3>Query Results:</h3>
								 <div id="idb_facts" style="overflow-y: scroll; height:150px;width:300px;"></div>
								
						</div>
				</div>
			</section>
			<label for="cars"><b>Choose fact to explain:</b></label>
			<select id="dropdownIDB">
			</select>

           <hr/>
			<button py-click="explanation_query()" id="button" class="py-button">
				Run Explanation Query $Q_e$
			</button>
			<section class="content">
				<h4>Result</h4>
				<div class="divcontainer">
					<div id = "deterministic" style="width:450px;">
						<h4>Deterministic Verbalization:</h4>
						<div id = "res_det"></div>
					</div>
					<div id = "template_cont" style="width:450px;">
						<h4>Our Framework:</h4>
						<div id="result"></div>
					</div>
				
				</div>
			</section>
			<hr/>
		</div>
		<div id="path"></div>

	</body>
</html>
<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/spin-2.3.2.js"></script>
<script src="js/classie.js"></script>
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
	  tex2jax: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
	});
  </script>
<script type="text/javascript" src="js/classie.js"></script>
<script type="text/javascript">
	(function() {
		// trim polyfill : https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/Trim
		if (!String.prototype.trim) {
			(function() {
				// Make sure we trim BOM and NBSP
				var rtrim = /^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;
				String.prototype.trim = function() {
					return this.replace(rtrim, '');
				};
			})();
		}

		[].slice.call( document.querySelectorAll( 'input.input__field' ) ).forEach( function( inputEl ) {
			// in case the input is already filled..
			if( inputEl.value.trim() !== '' ) {
				classie.add( inputEl.parentNode, 'input--filled' );
			}

			// events:
			inputEl.addEventListener( 'focus', onInputFocus );
			inputEl.addEventListener( 'blur', onInputBlur );
		} );

		function onInputFocus( ev ) {
			classie.add( ev.target.parentNode, 'input--filled' );
		}

		function onInputBlur( ev ) {
			if( ev.target.value.trim() === '' ) {
				classie.remove( ev.target.parentNode, 'input--filled' );
			}
		}
	})();
</script>

<script type="text/javascript">
	$("#examples").change(function() {
		// jQuery
		var selectedVal = $(this).find(':selected').val();
		// var selectedText = $(this).find(':selected').text();
    if (selectedVal == "PR"){
          var desc = "<b>Description</b>: The program detects potential conflicts of interest (CoI) according to general peer review rules. Multiple conditions might determine a CoI, and we ranked them according to the severity of the CoI, which can be further investigated by looking at the generated NL report to decide whether the exclusion really applies. ";
		  var path = "conflicts"
		  $("#path").val(path)
		  $("#desc").html(desc);
		  $("#query").html("<b>Query of interest:</b>$$?-ExcludeReviewer(y,s)$$");
		  $("#logicProgram").html("$$Researcher(x,z,d),Researcher(y,z,d), x \\neq y \\to Conflict(x,y)$$ \n $$hasPublication(x,p),hasPublication(y,p), x \\neq y  \\to Conflict(x,y)$$ \n $$Conflict(x,y), Submission(x,s) \\to ExcludeReviewer(y,s)$$");
		  MathJax.Hub.Queue(["Typeset", MathJax.Hub, "logicProgram"]);
		  MathJax.Hub.Queue(["Typeset", MathJax.Hub, "query"]);
    }
    else if(selectedVal == "TR"){
        var desc = "<b>Description</b>: Logic programs can be to define Smart Contracts which run on a blockchain. This program describes a simple version of trading of an asset via a Smart Contract, where a trader can send Open position orders, Close position orders and with market information evolving (Price)";
		var path = "trading"
		$("#path").val(path)
		$("#desc").html(desc);
		$("#query").html("<b>Query of interest:</b>$$?-Returns(x,pl)$$");
		$("#logicProgram").html("$$\\textit{Open}(x,y,t_1), \\neg \\textit{MarketClosed}(t_1) \\to \\textit{Accepted}(x,y,t_1)$$ \n  $$\\textit{Accepted}(x,y,t_1), \\textit{Price}(p_1,t_1), k=y*p_1  \\to \\textit{Position}(x,y,k,t_1)$$ \n $$\\textit{Close}(x,t_2), \\textit{Price}(p_2,t_2), \\textit{Position}(x,y,k,t_1), t_2>t_1, pl=y*p_2-k \\to \\textit{Returns(x,pl)}$$");
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "logicProgram"]);
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "query"]);
    }
    else if(selectedVal == "OW"){
        var desc = "<b>Description</b>:The ownership program finds chains of controls between companies and features direct recursion and aggregation.";
		var path = "ownership"
		$("#path").val(path)
		$("#desc").html(desc);
		$("#query").html("<b>Query of interest:</b>$$?-Control(x,y)$$");
		$("#logicProgram").html("$$\\textit{Company}(x) \\to \\textit{Control}(x,x)$$ \n $$\\textit{Control}(x,y),\\textit{Own}(y,z),s=\\textit{msum}(z,y),s>50 \\to \\textit{Control}(x,z)$$");
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "logicProgram"]);
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "query"]);
    }
    else if(selectedVal == "CL"){
        var desc = "<b>Description</b>: The Close Link program is a complex problem in the finance field that detects whether and how a close link exists between two entities due to an intricate set of shares' ownership relationships";
		var path = "closeLink"
		$("#path").val(path)
		$("#desc").html(desc);
		$("#query").html("<b>Query of interest:</b>$$?-closeLink(x,y)$$");
		$("#logicProgram").html("$$\\textit{Own}(c_1,c_2,s)\\to MC(c_1,c_2,s)$$\n $$MC(c_1,c_2,s_1),\\textit{Own}(c_2,c_3,s_2) \\to MC(c_1,c_3,s_1*s_2)$$ \n $$MC(c_4,c_5,s),ts=msum(s),ts>0.2 \\to \\textit{CloseLink}(c_4,c_5)$$");
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "logicProgram"]);
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "query"]);
    }
    else if(selectedVal == "SP"){
        var desc = "<b>Description</b>: Shock Propagation";
		var path = "shock"
		$("#path").val(path)
		$("#desc").html(desc);
		$("#query").html("<b>Query of interest:</b>$$?-Default(x)$$");
		$("#logicProgram").html("$$\\textit{Shock}(f,s),\\textit{FinInt}(f,p), s>p \\to \\textit{Default}(f)$$ \n $$\\textit{Default}(d),\\textit{LongTerm}(d,c,v), e_l=msum(v) \\to \\textit{Risk}(c,e_l,\\textit{long})$$ \n $$\\textit{Default}(d),\\textit{ShortTerm}(d,c,v), e_s=msum(v) \\to \\textit{Risk}(c,e_s,\\textit{short})$$ \n  $$\\textit{Risk}(c,e,t),\\textit{FinInt}(c,p), \\textit{l}=msum(e),\\textit{l}>p \\to \\textit{Default}(c)$$");
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "logicProgram"]);
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "query"]);
    }
   });
</script>
<script type="text/javascript">
		var desc = "";
		var path = "conflicts"
		$("#path").val(path)
		$("#desc").html(desc);
		$("#query")("");
		$("#logicProgram").html("");



</script>

<py-script>
from js import document
import pandas as pd
import json
from pyodide.http import open_url
from datetime import datetime as dt
from pyodide.ffi.wrappers import add_event_listener
from pycode import AggregateVerbalizer
from pycode import ProgramVerbalizer
from pycode import TemplatesGenerator
from pycode.utils import *

def get_data(*args, **kws):
	df = pd.read_json("data/"+Element("path").value+"/chase.json")[['name','provenance']]
	df2 = df[df['provenance'] == "[]"]['name'].reset_index(drop = True).to_string(header = False, index = False)
	Element('edb_facts').write(df2)
	if "conflicts" in Element("path").value:
		df = df[df['name'].str.startswith('excludeReviewer(')][['name']]
		df_write = df.reset_index(drop = True).to_string(header = False, index = False)
		Element('idb_facts').write(df_write)
	elif "trading" in Element("path").value:
		df = df[df['name'].str.startswith('returns(')][['name']]
		df_write = df.reset_index(drop = True).to_string(header = False, index = False)
		Element('idb_facts').write(df_write)
	elif "ownership" in Element("path").value:
		df = df[df['name'].str.startswith('control(')][['name']]
		df_write = df.reset_index(drop = True).to_string(header = False, index = False)
		Element('idb_facts').write(df_write)
	elif "closeLink" in Element("path").value:
		df = df[df['name'].str.startswith('closelink(')][['name']]
		df_write = df.reset_index(drop = True).to_string(header = False, index = False)
		Element('idb_facts').write(df_write)
	elif "shock" in Element("path").value:
		df = df[df['name'].str.startswith('default(')][['name']]
		df_write = df.reset_index(drop = True).to_string(header = False, index = False)
		Element('idb_facts').write(df_write)
	new_options = ""
	for i in range(len(df)):
		new_options = new_options + "<option>"+df.iloc[i]['name']+"</option>"
	Element("dropdownIDB").element.innerHTML = new_options

def explanation_query(*args, **kws):
	path = Element("path").value
	url = "data/"+path+"/chase.json"
	with open('data/'+path+'/templates.json') as f:
		templates_full = json.load(f)
	chase_fact = list()
	chase_fact.append(AggregateVerbalizer.VerbalizationFinder().get_chase_fact(url,Element("dropdownIDB").value))
	try: 
		verb = TemplatesGenerator.TemplatesGenerator().mapping_to_template(chase_fact[0][0], chase_fact[0][1], templates_full, templates_full, 'data/'+path+'/', Element("dropdownIDB").value, 'data/'+path+'/deterministic_verbalization.json')
		Element("res_det").write(verb[['Original Verbalization']].to_string(header = False, index = False))
		Element("result").write(verb[['Paraphrased Verbalization']].to_string(header = False, index = False))
	except Exception as e:
		print(f"An error occurred: {e}")
</py-script>