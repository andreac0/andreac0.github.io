<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>NL_Framework</title>
		<link rel="stylesheet" type="text/css" href="css/normalize.css"/>
		<link rel="stylesheet" type="text/css" href="css/demo.css"/>

		<!--必要样式-->
		<link rel="stylesheet" type="text/css" href="css/component.css"/>
		<link rel="stylesheet" type="text/css" href="css/style.css"/>

    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <py-config>
       packages =["./static/littleutils-0.2.2-py3-none-any.whl", "pandas"]
       [[fetch]]
       files=["./main.py"]
    </py-config>
	</head>
	<body>
		<div class="container">
			<header class="codrops-header">
				<h2>Logic to NL Explanation Framework</h2>
			</header>

				<section class="content">
				<label for="cars"><b>Examples:</b></label>

				<select name="examples" id="examples" py-click="get_data()">
				  	<option value="PR">Peer Reviews Conflict of Interest</option>
					<option value="TR">Trading via Smart Contract</option>
			   </select>
			<br/><br/>
			   <div id="logicProgram" style="font-size: 70%"></div>
			<br/><br/>
				 <div id="desc" align="left"></div>
			<br/><br/>
				<div id="query" style="font-size: 80%"></div>
			


      </section>

			<section class="content">
				<div class="divcontainer">
						<div class="dataset">
								<h3>EDB Knowledge:</h3>
									<div id="edb_facts" style="overflow-y: scroll; height:150px;width:300px;">
										<py-script>
											import pandas as pd
											from pyodide.http import open_url
											url = "https://raw.githubusercontent.com/andreac0/nl_framework/main/data/"+Element("path").value+"/chase.json"
											df = pd.read_json(open_url(url))[['name','provenance']]
											df = df[df['provenance'] == "[]"]['name'].reset_index(drop = True).to_string(header = False, index = False)
											Element('edb_facts').write(df)
										</py-script>
								</div>
						</div>

						<div class="fact" >
								 <h3>Query Results:</h3>
								 <div id="idb_facts" style="overflow-y: scroll; height:150px;width:300px;"></div>
								 <py-script>
								   import pandas as pd
								   from pyodide.http import open_url
								   url = "https://raw.githubusercontent.com/andreac0/nl_framework/main/data/"+Element("path").value+"/chase.json"
								   df = pd.read_json(open_url(url))[['name']]
								   df = df[df['name'].str.startswith("excludeReviewer(")].reset_index(drop = True).to_string(header = False, index = False)
								   Element('idb_facts').write(df)

								 </py-script>
								
						</div>
				</div>
			</section>
			<label for="cars"><b>Choose fact to explain:</b></label>
			<select id="dropdownIDB">
				<option>excludeReviewer(Isabel,561)</option>
				<option>excludeReviewer(Carlo,561)</option>
			</select>

           <hr/>
			<button py-click="speak()" id="button" class="py-button">
				Run Explanation Query $Q_e$
			</button>
			<section class="content">
				<h4>Result</h4>
				<div class="divcontainer">
					<div id="result"></div>
				</div>
			</section>
			<hr/>
		</div>
		<div id="path"></div>

	</body>
</html>
<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/spin-2.3.2.js"></script>
<script src="js/classie.js"></script>
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
	  tex2jax: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
	});
  </script>
<script type="text/javascript" src="js/classie.js"></script>
<script type="text/javascript">
	(function() {
		// trim polyfill : https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/Trim
		if (!String.prototype.trim) {
			(function() {
				// Make sure we trim BOM and NBSP
				var rtrim = /^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;
				String.prototype.trim = function() {
					return this.replace(rtrim, '');
				};
			})();
		}

		[].slice.call( document.querySelectorAll( 'input.input__field' ) ).forEach( function( inputEl ) {
			// in case the input is already filled..
			if( inputEl.value.trim() !== '' ) {
				classie.add( inputEl.parentNode, 'input--filled' );
			}

			// events:
			inputEl.addEventListener( 'focus', onInputFocus );
			inputEl.addEventListener( 'blur', onInputBlur );
		} );

		function onInputFocus( ev ) {
			classie.add( ev.target.parentNode, 'input--filled' );
		}

		function onInputBlur( ev ) {
			if( ev.target.value.trim() === '' ) {
				classie.remove( ev.target.parentNode, 'input--filled' );
			}
		}
	})();
</script>

<script type="text/javascript">
	$("#examples").change(function() {
		// jQuery
		var selectedVal = $(this).find(':selected').val();
		// var selectedText = $(this).find(':selected').text();
    if (selectedVal == "PR"){
          var desc = "<b>Description</b>: The program detects potential conflicts of interest (CoI) according to general peer review rules. Multiple conditions might determine a CoI, and we ranked them according to the severity of the CoI, which can be further investigated by looking at the generated NL report to decide whether the exclusion really applies. ";
		  var path = "conflicts"
		  $("#path").val(path)
		  $("#desc").html(desc);
		  $("#query").html("<b>Query of interest:</b>$$?-ExcludeReviewer(y,s)$$");
		  $("#logicProgram").html("$$Researcher(x,z,d),Researcher(y,z,d), x \\neq y \\to Conflict(x,y)$$ \n $$hasPublication(x,p),hasPublication(y,p), x \\neq y  \\to Conflict(x,y)$$ \n $$Conflict(x,y), Submission(x,s) \\to ExcludeReviewer(y,s)$$");
		  MathJax.Hub.Queue(["Typeset", MathJax.Hub, "logicProgram"]);
		  MathJax.Hub.Queue(["Typeset", MathJax.Hub, "query"]);
    }
    else if(selectedVal == "TR"){
        var desc = "<b>Description</b>: Logic programs can be to define Smart Contracts which run on a blockchain. This program describes a simple version of trading of an asset via a Smart Contract, where a trader can send Open position orders, Close position orders and with market information evolving (Price)";
		var path = "trading"
		$("#path").val(path)
		$("#desc").html(desc);
		$("#query").html("<b>Query of interest:</b>$$?-Return(x,pl)$$");
		$("#logicProgram").html("$$\\textit{Open}(x,y,t_1), \\neg \\textit{MarketClosed}(t_1) \\to \\textit{Accepted}(x,y,t_1)$$ \n  $$\\textit{Accepted}(x,y,t_1), \\textit{Price}(p_1,t_1), k=y*p_1  \\to \\textit{Position}(x,y,k,t_1)$$ \n $$\\textit{Close}(x,t_2), \\textit{Price}(p_2,t_2), \\textit{Position}(x,y,k,t_1), t_2>t_1, pl=y*p_2-k \\to \\textit{Return(x,pl)}$$");
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "logicProgram"]);
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "query"]);
    }
   });
</script>
<script type="text/javascript">
		var desc = "<b>Description</b>: The program detects potential conflicts of interest (CoI) according to general peer review rules. Multiple conditions might determine a CoI, and we ranked them according to the severity of the CoI, which can be further investigated by looking at the generated NL report to decide whether the exclusion really applies. ";
		var path = "conflicts"
		$("#path").val(path)
		$("#desc").html(desc);
		$("#query")("<b>Query of interest:</b>$$?-ExcludeReviewer(y,s)$$");
		$("#logicProgram").html("$$Researcher(x,z,d),Researcher(y,z,d), x \\neq y \\to Conflict(x,y)$$ \n $$hasPublication(x,p),hasPublication(y,p), x \\neq y  \\to Conflict(x,y)$$ \n $$Conflict(x,y), Submission(x,s) \\to ExcludeReviewer(y,s)$$");
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "logicProgram"]);
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, "query"]);


</script>

<py-script>
from js import document
import pandas as pd
from pyodide.http import open_url
from datetime import datetime as dt
from pyodide.ffi.wrappers import add_event_listener


def get_data(*args, **kws):
	url = "https://raw.githubusercontent.com/andreac0/nl_framework/main/data/"+Element("path").value+"/chase.json"
	df = pd.read_json(open_url(url))[['name','provenance']]
	df2 = df[df['provenance'] == "[]"]['name'].reset_index(drop = True).to_string(header = False, index = False)
	Element('edb_facts').write(df2)
	if "conflicts" in Element("path").value:
		df = df[df['name'].str.startswith('excludeReviewer(')][['name']]
		df_write = df.reset_index(drop = True).to_string(header = False, index = False)
		Element('idb_facts').write(df_write)
	elif "trading" in Element("path").value:
		df = df[df['name'].str.startswith('profit')][['name']]
		df_write = df.reset_index(drop = True).to_string(header = False, index = False)
		Element('idb_facts').write(df_write)
	new_options = ""
	for i in range(len(df)):
		new_options = new_options + "<option>"+df.iloc[i]['name']+"</option>"
	Element("dropdownIDB").element.innerHTML = new_options

def speak(*args, **kws):
	Element('result').write('Explanation')

def entailment():
	fact =  Element('fact').element.value
	dataset = Element('dataset').element.value
	dataset = dataset.split("\n")
	program = Element('program').element.value
	program = program.split("\n")
	#result = app.is_entail(program, dataset, fact)
	result = "jfofp"
	if result != "automata":
		Element('result').element.innerHTML = result
	else:
		Element('result').element.innerHTML = "Sorry, we currently do not support recursive programs with unbounded intervals."

</py-script>
